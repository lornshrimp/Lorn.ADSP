# 广告投放业务序列设计

## 1. 总体业务序列概览

广告投放业务涉及多个角色和系统间的交互，从广告计划创建到最终效果评估，构成了一个完整的业务闭环。以下序列图描述了整体业务流程中关键系统的交互过程。

```mermaid
sequenceDiagram
    participant 广告主
    participant 投放管理系统
    participant 审核系统
    participant 广告资源管理
    participant 投放引擎
    participant 用户终端
    participant 数据分析平台
    
    rect rgb(240, 240, 255)
    note right of 广告主: 投放前准备阶段
    广告主->>投放管理系统: 创建广告计划
    投放管理系统->>投放管理系统: 生成计划ID
    投放管理系统-->>广告主: 返回计划基本信息
    广告主->>投放管理系统: 配置投放策略
    广告主->>广告资源管理: 上传创意素材
    广告资源管理->>广告资源管理: 关联创意与广告计划
    广告资源管理-->>投放管理系统: 返回创意关联信息
    投放管理系统->>审核系统: 提交广告计划审核
    审核系统->>审核系统: 执行计划参数审核
    审核系统->>审核系统: 执行预算合规性审核
    审核系统->>广告资源管理: 请求创意内容审核
    广告资源管理-->>审核系统: 返回创意审核结果
    审核系统->>审核系统: 执行落地页审核
    审核系统->>审核系统: 生成综合审核结果
    审核系统-->>投放管理系统: 返回审核结果
    投放管理系统-->>广告主: 通知审核结果
    end

    rect rgb(240, 255, 240)
    note right of 广告主: 投放执行阶段
    广告主->>投放管理系统: 启动投放
    投放管理系统->>投放管理系统: 检查时间条件和预算
    投放管理系统->>投放引擎: 下发投放参数
    
    loop 投放周期
        用户终端->>投放引擎: 发送广告请求
        投放引擎->>投放引擎: 解析请求上下文
        投放引擎->>投放引擎: 根据策略筛选广告
        投放引擎->>投放引擎: 执行实时竞价
        投放引擎-->>用户终端: 返回广告展示内容
        用户终端->>用户终端: 展示广告
        用户终端->>投放引擎: 上报用户交互行为
        投放引擎->>数据分析平台: 实时数据回传
        数据分析平台-->>投放管理系统: 聚合效果数据
        
        alt 需要优化
            投放管理系统->>投放管理系统: 分析指标异常
            投放管理系统->>投放管理系统: 生成优化策略
            投放管理系统->>投放引擎: 更新投放策略
        else 需要干预
            投放管理系统->>广告主: 发送异常预警
            广告主->>投放管理系统: 执行紧急干预操作
            投放管理系统->>投放引擎: 紧急策略调整
        end
    end
    end

    rect rgb(255, 240, 240)
    note right of 广告主: 投放后评估阶段
    数据分析平台->>数据分析平台: 收集完整投放数据
    数据分析平台->>数据分析平台: 清洗与处理数据
    数据分析平台->>数据分析平台: 计算核心效果指标
    数据分析平台-->>投放管理系统: 生成效果数据集
    投放管理系统->>投放管理系统: 执行多维度分析
    投放管理系统->>投放管理系统: 计算ROI指标
    投放管理系统->>投放管理系统: 总结投放经验
    投放管理系统->>投放管理系统: 制定优化方案
    投放管理系统-->>广告主: 提供投放报告与建议
    广告主->>投放管理系统: 确认下一轮投放策略
    end
```

## 2. 子序列设计

### 2.1 广告计划创建序列图

```mermaid
sequenceDiagram
    participant 广告主
    participant 投放管理系统
    participant 账户系统
    
    广告主->>投放管理系统: 请求创建广告计划
    投放管理系统->>账户系统: 验证广告主账户状态
    
    alt 账户状态正常
        账户系统-->>投放管理系统: 返回账户验证通过
        投放管理系统-->>广告主: 显示计划创建表单
        广告主->>投放管理系统: 填写计划基础信息
        广告主->>投放管理系统: 设置投放目标
        广告主->>投放管理系统: 设置投放预算
        广告主->>投放管理系统: 设置投放时间
        广告主->>投放管理系统: 设置投放区域
        广告主->>投放管理系统: 设置投放分类标签
        
        投放管理系统->>投放管理系统: 校验预算充足性
        
        alt 预算充足
            投放管理系统->>投放管理系统: 保存计划配置
            投放管理系统->>投放管理系统: 生成计划ID
            投放管理系统->>投放管理系统: 设置计划状态为"草稿"
            
            alt 提交审核
                广告主->>投放管理系统: 请求提交审核
                投放管理系统->>投放管理系统: 更新状态为"待审核"
                投放管理系统-->>广告主: 返回提交审核成功
            else 保存草稿
                投放管理系统-->>广告主: 返回保存草稿成功
            end
            
        else 预算不足
            投放管理系统-->>广告主: 显示预算不足提示
            广告主->>投放管理系统: 调整预算
        end
        
    else 账户状态异常
        账户系统-->>投放管理系统: 返回账户验证失败
        投放管理系统-->>广告主: 显示账户异常提示
    end
```

### 2.2 投放策略配置序列图

```mermaid
sequenceDiagram
    participant 广告主
    participant 投放管理系统
    participant 策略引擎
    
    广告主->>投放管理系统: 请求配置投放策略
    投放管理系统->>投放管理系统: 加载计划基础信息
    投放管理系统-->>广告主: 显示策略配置界面
    
    广告主->>投放管理系统: 选择投放渠道
    广告主->>投放管理系统: 配置人群定向策略
    广告主->>投放管理系统: 设置场景定向
    广告主->>投放管理系统: 配置兴趣标签
    广告主->>投放管理系统: 设置设备定向
    广告主->>投放管理系统: 配置出价策略
    广告主->>投放管理系统: 选择出价模式(CPM/CPC/CPA等)
    广告主->>投放管理系统: 设置基础出价
    广告主->>投放管理系统: 配置预算分配策略
    广告主->>投放管理系统: 设置投放速率
    广告主->>投放管理系统: 配置分时段投放权重
    广告主->>投放管理系统: 设置频次控制
    广告主->>投放管理系统: 设置流量分配策略
    广告主->>投放管理系统: 设置投放优先级
    
    投放管理系统->>策略引擎: 提交策略合规性校验
    
    alt 策略合规
        策略引擎-->>投放管理系统: 返回校验通过
        投放管理系统->>投放管理系统: 保存策略配置
        
        alt 配置自动优化
            广告主->>投放管理系统: 请求配置自动优化规则
            投放管理系统->>投放管理系统: 保存自动优化配置
        end
        
        投放管理系统-->>广告主: 返回策略配置成功
        
    else 策略不合规
        策略引擎-->>投放管理系统: 返回校验不通过
        投放管理系统-->>广告主: 显示策略优化建议
        广告主->>投放管理系统: 调整策略参数
        投放管理系统->>策略引擎: 重新提交校验
    end
```

### 2.3 投放前审核序列图

```mermaid
sequenceDiagram
    participant 广告主
    participant 投放管理系统
    participant 审核系统
    participant 资源管理系统
    
    广告主->>投放管理系统: 提交广告审核
    投放管理系统->>审核系统: 转发审核请求
    
    par 并行审核流程
        审核系统->>审核系统: 投放参数审核
        审核系统->>审核系统: 预算合规性审核
        审核系统->>资源管理系统: 创意内容审核
        审核系统->>审核系统: 落地页审核
    end
    
    资源管理系统-->>审核系统: 返回创意审核结果
    
    审核系统->>审核系统: 汇总所有审核结果
    
    alt 全部审核通过
        审核系统->>投放管理系统: 返回审核通过结果
        投放管理系统->>投放管理系统: 更新计划状态为"待投放"
        投放管理系统-->>广告主: 发送审核通过通知
    else 部分审核不通过
        审核系统->>投放管理系统: 返回审核失败结果
        投放管理系统->>投放管理系统: 更新计划状态为"已驳回"
        投放管理系统-->>广告主: 发送审核失败通知及原因
    end
```

### 2.4 实时投放序列图

```mermaid
sequenceDiagram
    participant 用户
    participant 用户终端
    participant 投放引擎
    participant 竞价系统
    participant 频次控制
    participant 预算控制
    participant 数据回流
    
    用户->>用户终端: 访问广告位内容
    用户终端->>投放引擎: 发送广告请求(设备信息、位置等)
    投放引擎->>投放引擎: 解析请求上下文
    投放引擎->>频次控制: 检查用户频次限制
    频次控制-->>投放引擎: 返回频次状态
    
    alt 未达频次上限
        投放引擎->>投放引擎: 初步筛选符合条件广告
        投放引擎->>竞价系统: 发送竞价请求
        
        竞价系统->>竞价系统: 执行广告筛选规则
        竞价系统->>竞价系统: 计算广告相关性得分
        竞价系统->>竞价系统: 应用出价策略与因子
        竞价系统->>竞价系统: 执行竞价排序算法
        竞价系统->>预算控制: 检查广告预算状态
        
        alt 预算充足
            预算控制-->>竞价系统: 返回预算检查通过
            竞价系统-->>投放引擎: 返回胜出广告
            投放引擎-->>用户终端: 返回广告展示内容
            
            用户终端->>用户终端: 渲染广告内容
            用户终端->>数据回流: 上报曝光事件
            
            alt 用户点击广告
                用户->>用户终端: 点击广告
                用户终端->>用户终端: 执行点击操作
                用户终端->>数据回流: 上报点击事件
                预算控制->>预算控制: 记录消费(CPC模式)
            end
            
            alt 用户完成转化
                用户->>用户终端: 执行转化动作
                用户终端->>数据回流: 上报转化事件
                预算控制->>预算控制: 记录消费(CPA模式)
            end
            
            预算控制->>预算控制: 记录消费(CPM模式)
            
        else 预算不足
            预算控制-->>竞价系统: 返回预算不足
            竞价系统-->>投放引擎: 通知预算不足
            投放引擎->>投放引擎: 选择下一个匹配广告
        end
        
    else 已达频次上限
        投放引擎->>投放引擎: 排除受频次限制的广告
        投放引擎->>投放引擎: 选择其他匹配广告
    end
```

### 2.5 投放监控与优化序列图

```mermaid
sequenceDiagram
    participant 数据回流系统
    participant 实时监控系统
    participant 异常检测系统
    participant 优化决策系统
    participant 投放引擎
    participant 广告主
    
    loop 定期监控
        数据回流系统->>实时监控系统: 发送实时投放数据
        实时监控系统->>实时监控系统: 数据聚合与处理
        实时监控系统->>实时监控系统: 计算核心指标
        
        par 并行监控流程
            实时监控系统->>异常检测系统: 检查展示指标
            实时监控系统->>异常检测系统: 检查点击指标
            实时监控系统->>异常检测系统: 检查转化指标
            实时监控系统->>异常检测系统: 检查预算消耗
        end
        
        alt 检测到异常
            异常检测系统->>优化决策系统: 发送指标异常告警
            优化决策系统->>优化决策系统: 汇总问题诊断结果
            
            alt 满足自动优化条件
                优化决策系统->>优化决策系统: 生成优化策略
                优化决策系统->>投放引擎: 应用策略调整
                投放引擎->>投放引擎: 记录优化操作日志
            else 需要人工干预
                优化决策系统->>广告主: 发送优化建议通知
                广告主->>优化决策系统: 确认干预操作
                优化决策系统->>投放引擎: 应用人工策略调整
            end
            
        else 指标正常
            异常检测系统->>实时监控系统: 更新正常状态记录
            实时监控系统->>实时监控系统: 更新监控面板数据
        end
    end
```

### 2.6 投放后ROI评估序列图

```mermaid
sequenceDiagram
    participant 广告主
    participant 投放管理系统
    participant 数据分析平台
    participant 知识库系统
    
    广告主->>投放管理系统: 请求投放效果报告
    投放管理系统->>数据分析平台: 请求完整投放数据
    
    数据分析平台->>数据分析平台: 收集完整投放周期数据
    数据分析平台->>数据分析平台: 计算总投入成本
    数据分析平台->>数据分析平台: 统计各渠道展示量
    数据分析平台->>数据分析平台: 统计各渠道点击量
    数据分析平台->>数据分析平台: 统计各渠道转化量
    数据分析平台->>数据分析平台: 计算点击率CTR
    数据分析平台->>数据分析平台: 计算转化率CVR
    数据分析平台->>数据分析平台: 计算平均点击成本CPC
    数据分析平台->>数据分析平台: 计算平均转化成本CPA
    数据分析平台->>数据分析平台: 计算预期转化价值
    数据分析平台->>数据分析平台: 计算投资回报率ROI
    
    数据分析平台-->>投放管理系统: 返回完整效果数据
    
    投放管理系统->>投放管理系统: 分析ROI指标
    
    alt ROI达标
        投放管理系统->>投放管理系统: 标记为高效投放
        投放管理系统->>投放管理系统: 生成高效因素分析
    else ROI不达标
        投放管理系统->>投放管理系统: 标记为待优化投放
        投放管理系统->>投放管理系统: 生成优化建议
    end
    
    投放管理系统->>投放管理系统: 整合评估报告
    投放管理系统->>知识库系统: 更新投放经验总结
    投放管理系统-->>广告主: 提供完整投放报告
```

## 3. 关键交互节点说明

### 3.1 投放前准备阶段关键交互

1. **广告计划创建到审核**
   - 广告主通过投放管理系统创建广告计划，设置基本信息和投放策略
   - 系统检查账户状态和预算充足性，确保基础条件满足
   - 投放管理系统与审核系统的交互确保广告计划符合平台规范

2. **创意素材管理与关联**
   - 广告主上传创意素材到资源管理系统
   - 资源管理系统执行素材规范检查
   - 创意素材与广告计划关联，构成完整投放单元

3. **多维度审核协作**
   - 审核系统与资源管理系统协同工作，执行参数、预算、创意、落地页多维度审核
   - 审核结果汇总后决定广告计划是否可投放
   - 审核结果通知机制确保广告主及时了解审核状态

### 3.2 投放执行阶段关键交互

1. **投放启动与参数下发**
   - 广告主启动投放后，投放管理系统检查时间条件和预算状态
   - 投放参数下发到投放引擎，准备响应广告请求
   - 系统状态从"待投放"切换到"投放中"

2. **广告请求与实时竞价**
   - 用户终端发起广告请求，携带上下文信息
   - 投放引擎根据请求上下文和投放策略筛选匹配广告
   - 竞价系统执行排序和选择，考虑频次控制和预算限制

3. **用户交互与数据回流**
   - 用户与广告的交互行为(展示、点击、转化)由终端记录
   - 交互数据实时回传到数据回流系统
   - 数据聚合后用于实时监控和优化决策

4. **实时监控与优化**
   - 监控系统分析实时数据，检测异常指标
   - 优化决策系统根据监控结果生成优化策略
   - 策略调整自动或人工干预方式应用到投放引擎

### 3.3 投放后评估阶段关键交互

1. **数据收集与处理**
   - 数据分析平台收集完整投放周期数据
   - 执行数据清洗、聚合和计算关键指标
   - 生成多维度分析数据集供投放管理系统使用

2. **效果分析与ROI评估**
   - 投放管理系统基于数据集执行多维度分析
   - 计算和评估ROI指标，判断投放效率
   - 根据ROI表现生成相应分析和建议

3. **经验沉淀与策略优化**
   - 投放经验和最佳实践更新至知识库系统
   - 基于历史数据和经验总结制定优化方案
   - 优化建议反馈给广告主，指导下一轮投放

## 4. 异常处理流程

### 4.1 审核阶段异常处理

```mermaid
sequenceDiagram
    participant 广告主
    participant 投放管理系统
    participant 审核系统
    
    广告主->>投放管理系统: 提交广告审核
    投放管理系统->>审核系统: 转发审核请求
    
    alt 审核失败
        审核系统-->>投放管理系统: 返回审核失败及原因
        投放管理系统-->>广告主: 通知审核失败原因
        广告主->>投放管理系统: 修改广告内容
        投放管理系统->>审核系统: 重新提交审核
    else 审核超时
        广告主->>投放管理系统: 查询审核状态
        投放管理系统->>审核系统: 请求审核状态
        审核系统-->>投放管理系统: 返回审核处理中
        投放管理系统-->>广告主: 通知审核处理中，预计完成时间
    else 系统错误
        审核系统-->>投放管理系统: 返回系统错误
        投放管理系统->>投放管理系统: 记录错误日志
        投放管理系统->>审核系统: 重试审核请求
        投放管理系统-->>广告主: 通知临时系统错误，正在重试
    end
```

### 4.2 投放阶段异常处理

```mermaid
sequenceDiagram
    participant 监控系统
    participant 投放管理系统
    participant 投放引擎
    participant 广告主
    
    监控系统->>监控系统: 检测到严重异常
    监控系统->>投放管理系统: 发送严重异常告警
    
    alt 预算异常消耗
        投放管理系统->>投放引擎: 暂停相关广告投放
        投放管理系统->>广告主: 发送预算异常消耗警报
        广告主->>投放管理系统: 确认处理方案
        投放管理系统->>投放引擎: 应用预算调整
        投放引擎-->>投放管理系统: 确认预算调整完成
    else 点击率异常
        投放管理系统->>投放引擎: 降低问题广告优先级
        投放管理系统->>广告主: 发送点击率异常警报
        广告主->>投放管理系统: 提交创意替换
        投放管理系统->>投放引擎: 更新广告创意
        投放引擎-->>投放管理系统: 确认创意更新完成
    else 投放引擎故障
        投放管理系统->>投放引擎: 请求故障诊断
        投放引擎-->>投放管理系统: 返回故障状态
        投放管理系统->>投放引擎: 触发故障转移
        投放管理系统->>广告主: 通知系统临时故障，已启动备份流程
        投放管理系统->>投放管理系统: 持续监控恢复状态
    end
```

## 5. 业务序列优化方向

### 5.1 流程优化方向

1. **审核流程自动化**
   - 引入AI审核辅助工具，提高审核速度和准确性
   - 构建分级审核机制，简单案例自动审核，复杂案例人工审核
   - 建立预审核机制，提前发现潜在问题

2. **实时决策优化**
   - 增强实时优化能力，缩短数据到决策的延迟时间
   - 引入预测模型，实现前瞻性投放调整
   - 构建多层级优化策略库，应对不同场景

3. **跨系统协作优化**
   - 构建系统间事件通知机制，减少轮询依赖
   - 优化系统间数据传输格式，降低处理负担
   - 引入分布式事务管理，确保跨系统操作一致性

### 5.2 技术优化方向

1. **高并发处理优化**
   - 优化实时竞价系统性能，提高并发处理能力
   - 实现请求分级处理机制，确保核心流量稳定性
   - 引入负载均衡和弹性扩缩容机制

2. **数据流处理优化**
   - 实现增量数据同步机制，降低系统间数据传输量
   - 优化数据聚合算法，提高实时统计准确性
   - 构建数据缓存层，减轻数据库压力

3. **异常处理机制优化**
   - 完善故障检测和预警机制，提前发现潜在问题
   - 构建多级降级策略，确保核心功能可用性
   - 优化重试机制，提高系统容错能力