# 系统配置化和依赖注入设计

本目录包含 Lorn.ADSP 广告平台的统一配置化和依赖注入架构设计文档。

## 设计目标

为解决当前系统中配置和依赖注入实现分散、缺乏统一规范的问题，设计一个基于微软 Microsoft.Extensions.* 组件的统一架构，实现：

- **统一性**：所有组件使用相同的配置和注册模式
- **可扩展性**：支持动态发现和注册新组件，无需修改现有代码  
- **可配置性**：通过配置文件控制组件行为，无需重编译
- **可监控性**：内置健康检查和性能监控能力
- **可测试性**：基于接口的松耦合设计，便于单元测试

## 文档结构

### [统一配置化和依赖注入架构设计.md](./统一配置化和依赖注入架构设计.md)

**主要架构设计文档**，包含：

- **设计原则**：约定优于配置、元数据驱动、组合优于继承
- **架构设计**：整体架构视图和核心抽象接口设计
- **组件模型**：组件分类体系和元数据模型
- **配置模型**：分层配置架构和配置约定规范
- **依赖注入设计**：服务注册策略和生命周期管理
- **可扩展性设计**：插件化架构和扩展点设计
- **监控诊断设计**：健康检查和指标收集体系
- **实施策略**：分阶段实施计划和技术风险控制

### [统一扩展方法实现示例.md](./统一扩展方法实现示例.md)

**具体实现指导文档**，提供：

- **问题分析**：现有扩展方法的局限性和改进需求
- **统一基础设施**：核心抽象接口、组件元数据、注册构建器
- **改进实现**：数据访问、策略组件、定向计算器的统一扩展方法
- **使用示例**：应用程序配置、组件实现、配置文件标准化
- **代码重构**：从旧架构到新架构的迁移示例和对比

### [实施计划.md](./实施计划.md)

**详细实施计划和执行路线图**，包含：

- **阶段规划**：基础设施搭建、接口标准化、实现开发、系统迁移
- **迁移策略**：渐进式迁移、向后兼容、配置驱动、灰度发布
- **测试验证**：功能测试、性能测试、集成测试、监控告警
- **风险管理**：技术风险、业务风险、应对策略、成功标准
- **时间规划**：详细的工作量估算和里程碑设置

### [快速开始指南.md](./快速开始指南.md)

**快速实施方案**，提供：

- 基于微软组件的最小化实现
- **1-2天快速搭建**的实用指南
- 完整的代码示例和配置模板

## 核心设计亮点

### 基础设施导向的架构设计

**配置管理是具体实现，不是抽象接口**：

- 提供开箱即用的 `AdSystemConfigurationManager`
- 基于约定自动绑定所有 `*Options` 类到对应配置节
- 支持多配置源（JSON、环境变量、数据库等）
- 配置热重载和自动验证

**依赖注入是智能组装器，不是业务扩展点**：

- 提供智能的 `ComponentRegistrationManager`
- 基于约定自动发现和注册所有组件
- 自动推断组件生命周期和配置绑定
- 零代码修改的组件扩展

**约定优于配置的零配置设计**：

- `UserInterestRecallStrategy` 自动注册为 `IAdProcessingStrategy`
- `AdEngineOptions` 自动绑定到 `"AdEngine"` 配置节
- 以 `Manager`、`Service` 结尾的类自动注册为单例
- 实现 `IHealthCheckable` 的组件自动添加健康检查

### 真正的可扩展性

**零配置扩展**：

- 新增组件：创建类 → 实现接口 → 自动发现注册
- 新增配置：创建 `*Options` 类 → 自动绑定配置节
- 修改配置：编辑配置文件 → 自动热重载

**一键初始化**：

```csharp
// 使用者只需要一行代码
services.AddAdSystemInfrastructure(configuration);
```

### 基于微软生态的实现

**核心技术栈**：

- Microsoft.Extensions.Hosting - 应用程序宿主
- Microsoft.Extensions.DependencyInjection - 依赖注入
- Microsoft.Extensions.Configuration - 配置管理
- Microsoft.Extensions.Options - 强类型配置
- Microsoft.Extensions.HealthChecks - 健康检查

**预期效益**：

- **减少开发量 80%**：基于约定的零配置开发
- **提高系统稳定性**：基于成熟的微软组件
- **降低学习成本**：标准化的.NET开发模式
- **简化运维管理**：统一的配置和监控方式

## 实际应用效果

### 开发者只需要专注业务逻辑

**添加新的广告策略**：

```csharp
// 1. 创建策略类（自动发现和注册）
public class NewAdStrategy : IAdProcessingStrategy 
{
    // 2. 配置会自动注入
    public NewAdStrategy(IOptions<NewAdStrategyOptions> options) { }
    
    // 3. 只需实现业务逻辑
    public Task<ProcessingResult> ProcessAsync(...) { }
}

// 4. 创建配置类（自动绑定到 "Strategies:NewAd" 配置节）
public class NewAdStrategyOptions 
{
    public int MaxCandidates { get; set; } = 100;
}

// 5. 在配置文件中添加配置（支持热重载）
{
  "Strategies": {
    "NewAd": {
      "MaxCandidates": 200
    }
  }
}
```

**无需任何注册代码！** 一切都是自动的。

## 适用场景

### 广告引擎系统

- 策略集合的动态组装和配置
- 竞价算法的可插拔实现
- 实时配置调整和热重载

### 数据访问层

- 数据提供者的注册和路由
- 连接池和缓存的统一管理
- 数据源的动态切换

### 定向系统

- 定向计算器的动态注册
- 定向规则的配置化管理
- 算法优先级的动态调整

### 其他业务模块

- 任何需要配置驱动和动态扩展的组件
- 插件式功能模块
- 微服务化组件

这个设计将为 Lorn.ADSP 广告平台提供一个现代化、可扩展、易维护的统一配置和依赖注入基础架构。
